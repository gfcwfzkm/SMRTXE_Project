
#include "glcd_library.h"

const uint8_t font[] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x3E, 0x5B, 0x4F, 0x5B, 0x3E,
	0x3E, 0x6B, 0x4F, 0x6B, 0x3E,
	0x1C, 0x3E, 0x7C, 0x3E, 0x1C,
	0x18, 0x3C, 0x7E, 0x3C, 0x18,
	0x1C, 0x57, 0x7D, 0x57, 0x1C,
	0x1C, 0x5E, 0x7F, 0x5E, 0x1C,
	0x00, 0x18, 0x3C, 0x18, 0x00,
	0xFF, 0xE7, 0xC3, 0xE7, 0xFF,
	0x00, 0x18, 0x24, 0x18, 0x00,
	0xFF, 0xE7, 0xDB, 0xE7, 0xFF,
	0x30, 0x48, 0x3A, 0x06, 0x0E,
	0x26, 0x29, 0x79, 0x29, 0x26,
	0x40, 0x7F, 0x05, 0x05, 0x07,
	0x40, 0x7F, 0x05, 0x25, 0x3F,
	0x5A, 0x3C, 0xE7, 0x3C, 0x5A,
	0x7F, 0x3E, 0x1C, 0x1C, 0x08,
	0x08, 0x1C, 0x1C, 0x3E, 0x7F,
	0x14, 0x22, 0x7F, 0x22, 0x14,
	0x5F, 0x5F, 0x00, 0x5F, 0x5F,
	0x06, 0x09, 0x7F, 0x01, 0x7F,
	0x00, 0x66, 0x89, 0x95, 0x6A,
	0x60, 0x60, 0x60, 0x60, 0x60,
	0x94, 0xA2, 0xFF, 0xA2, 0x94,
	0x08, 0x04, 0x7E, 0x04, 0x08,
	0x10, 0x20, 0x7E, 0x20, 0x10,
	0x08, 0x08, 0x2A, 0x1C, 0x08,
	0x08, 0x1C, 0x2A, 0x08, 0x08,
	0x1E, 0x10, 0x10, 0x10, 0x10,
	0x0C, 0x1E, 0x0C, 0x1E, 0x0C,
	0x30, 0x38, 0x3E, 0x38, 0x30,
	0x06, 0x0E, 0x3E, 0x0E, 0x06,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x5F, 0x00, 0x00,
	0x00, 0x07, 0x00, 0x07, 0x00,
	0x14, 0x7F, 0x14, 0x7F, 0x14,
	0x24, 0x2A, 0x7F, 0x2A, 0x12,
	0x23, 0x13, 0x08, 0x64, 0x62,
	0x36, 0x49, 0x56, 0x20, 0x50,
	0x00, 0x08, 0x07, 0x03, 0x00,
	0x00, 0x1C, 0x22, 0x41, 0x00,
	0x00, 0x41, 0x22, 0x1C, 0x00,
	0x2A, 0x1C, 0x7F, 0x1C, 0x2A,
	0x08, 0x08, 0x3E, 0x08, 0x08,
	0x00, 0x80, 0x70, 0x30, 0x00,
	0x08, 0x08, 0x08, 0x08, 0x08,
	0x00, 0x00, 0x60, 0x60, 0x00,
	0x20, 0x10, 0x08, 0x04, 0x02,
	0x3E, 0x51, 0x49, 0x45, 0x3E,
	0x00, 0x42, 0x7F, 0x40, 0x00,
	0x72, 0x49, 0x49, 0x49, 0x46,
	0x21, 0x41, 0x49, 0x4D, 0x33,
	0x18, 0x14, 0x12, 0x7F, 0x10,
	0x27, 0x45, 0x45, 0x45, 0x39,
	0x3C, 0x4A, 0x49, 0x49, 0x31,
	0x41, 0x21, 0x11, 0x09, 0x07,
	0x36, 0x49, 0x49, 0x49, 0x36,
	0x46, 0x49, 0x49, 0x29, 0x1E,
	0x00, 0x00, 0x14, 0x00, 0x00,
	0x00, 0x40, 0x34, 0x00, 0x00,
	0x00, 0x08, 0x14, 0x22, 0x41,
	0x14, 0x14, 0x14, 0x14, 0x14,
	0x00, 0x41, 0x22, 0x14, 0x08,
	0x02, 0x01, 0x59, 0x09, 0x06,
	0x3E, 0x41, 0x5D, 0x59, 0x4E,
	0x7C, 0x12, 0x11, 0x12, 0x7C,
	0x7F, 0x49, 0x49, 0x49, 0x36,
	0x3E, 0x41, 0x41, 0x41, 0x22,
	0x7F, 0x41, 0x41, 0x41, 0x3E,
	0x7F, 0x49, 0x49, 0x49, 0x41,
	0x7F, 0x09, 0x09, 0x09, 0x01,
	0x3E, 0x41, 0x41, 0x51, 0x73,
	0x7F, 0x08, 0x08, 0x08, 0x7F,
	0x00, 0x41, 0x7F, 0x41, 0x00,
	0x20, 0x40, 0x41, 0x3F, 0x01,
	0x7F, 0x08, 0x14, 0x22, 0x41,
	0x7F, 0x40, 0x40, 0x40, 0x40,
	0x7F, 0x02, 0x1C, 0x02, 0x7F,
	0x7F, 0x04, 0x08, 0x10, 0x7F,
	0x3E, 0x41, 0x41, 0x41, 0x3E,
	0x7F, 0x09, 0x09, 0x09, 0x06,
	0x3E, 0x41, 0x51, 0x21, 0x5E,
	0x7F, 0x09, 0x19, 0x29, 0x46,
	0x26, 0x49, 0x49, 0x49, 0x32,
	0x03, 0x01, 0x7F, 0x01, 0x03,
	0x3F, 0x40, 0x40, 0x40, 0x3F,
	0x1F, 0x20, 0x40, 0x20, 0x1F,
	0x3F, 0x40, 0x38, 0x40, 0x3F,
	0x63, 0x14, 0x08, 0x14, 0x63,
	0x03, 0x04, 0x78, 0x04, 0x03,
	0x61, 0x59, 0x49, 0x4D, 0x43,
	0x00, 0x7F, 0x41, 0x41, 0x41,
	0x02, 0x04, 0x08, 0x10, 0x20,
	0x00, 0x41, 0x41, 0x41, 0x7F,
	0x04, 0x02, 0x01, 0x02, 0x04,
	0x40, 0x40, 0x40, 0x40, 0x40,
	0x00, 0x03, 0x07, 0x08, 0x00,
	0x20, 0x54, 0x54, 0x78, 0x40,
	0x7F, 0x28, 0x44, 0x44, 0x38,
	0x38, 0x44, 0x44, 0x44, 0x28,
	0x38, 0x44, 0x44, 0x28, 0x7F,
	0x38, 0x54, 0x54, 0x54, 0x18,
	0x00, 0x08, 0x7E, 0x09, 0x02,
	0x18, 0xA4, 0xA4, 0x9C, 0x78,
	0x7F, 0x08, 0x04, 0x04, 0x78,
	0x00, 0x44, 0x7D, 0x40, 0x00,
	0x20, 0x40, 0x40, 0x3D, 0x00,
	0x7F, 0x10, 0x28, 0x44, 0x00,
	0x00, 0x41, 0x7F, 0x40, 0x00,
	0x7C, 0x04, 0x78, 0x04, 0x78,
	0x7C, 0x08, 0x04, 0x04, 0x78,
	0x38, 0x44, 0x44, 0x44, 0x38,
	0xFC, 0x18, 0x24, 0x24, 0x18,
	0x18, 0x24, 0x24, 0x18, 0xFC,
	0x7C, 0x08, 0x04, 0x04, 0x08,
	0x48, 0x54, 0x54, 0x54, 0x24,
	0x04, 0x04, 0x3F, 0x44, 0x24,
	0x3C, 0x40, 0x40, 0x20, 0x7C,
	0x1C, 0x20, 0x40, 0x20, 0x1C,
	0x3C, 0x40, 0x30, 0x40, 0x3C,
	0x44, 0x28, 0x10, 0x28, 0x44,
	0x4C, 0x90, 0x90, 0x90, 0x7C,
	0x44, 0x64, 0x54, 0x4C, 0x44,
	0x00, 0x08, 0x36, 0x41, 0x00,
	0x00, 0x00, 0x77, 0x00, 0x00,
	0x00, 0x41, 0x36, 0x08, 0x00,
	0x02, 0x01, 0x02, 0x04, 0x02,
	0x3C, 0x26, 0x23, 0x26, 0x3C,
	0x1E, 0xA1, 0xA1, 0x61, 0x12,
	0x3A, 0x40, 0x40, 0x20, 0x7A,
	0x38, 0x54, 0x54, 0x55, 0x59,
	0x21, 0x55, 0x55, 0x79, 0x41,
	0x22, 0x54, 0x54, 0x78, 0x42, // a-umlaut
	0x21, 0x55, 0x54, 0x78, 0x40,
	0x20, 0x54, 0x55, 0x79, 0x40,
	0x0C, 0x1E, 0x52, 0x72, 0x12,
	0x39, 0x55, 0x55, 0x55, 0x59,
	0x39, 0x54, 0x54, 0x54, 0x59,
	0x39, 0x55, 0x54, 0x54, 0x58,
	0x00, 0x00, 0x45, 0x7C, 0x41,
	0x00, 0x02, 0x45, 0x7D, 0x42,
	0x00, 0x01, 0x45, 0x7C, 0x40,
	0x7D, 0x12, 0x11, 0x12, 0x7D, // A-umlaut
	0xF0, 0x28, 0x25, 0x28, 0xF0,
	0x7C, 0x54, 0x55, 0x45, 0x00,
	0x20, 0x54, 0x54, 0x7C, 0x54,
	0x7C, 0x0A, 0x09, 0x7F, 0x49,
	0x32, 0x49, 0x49, 0x49, 0x32,
	0x3A, 0x44, 0x44, 0x44, 0x3A, // o-umlaut
	0x32, 0x4A, 0x48, 0x48, 0x30,
	0x3A, 0x41, 0x41, 0x21, 0x7A,
	0x3A, 0x42, 0x40, 0x20, 0x78,
	0x00, 0x9D, 0xA0, 0xA0, 0x7D,
	0x3D, 0x42, 0x42, 0x42, 0x3D, // O-umlaut
	0x3D, 0x40, 0x40, 0x40, 0x3D,
	0x3C, 0x24, 0xFF, 0x24, 0x24,
	0x48, 0x7E, 0x49, 0x43, 0x66,
	0x2B, 0x2F, 0xFC, 0x2F, 0x2B,
	0xFF, 0x09, 0x29, 0xF6, 0x20,
	0xC0, 0x88, 0x7E, 0x09, 0x03,
	0x20, 0x54, 0x54, 0x79, 0x41,
	0x00, 0x00, 0x44, 0x7D, 0x41,
	0x30, 0x48, 0x48, 0x4A, 0x32,
	0x38, 0x40, 0x40, 0x22, 0x7A,
	0x00, 0x7A, 0x0A, 0x0A, 0x72,
	0x7D, 0x0D, 0x19, 0x31, 0x7D,
	0x26, 0x29, 0x29, 0x2F, 0x28,
	0x26, 0x29, 0x29, 0x29, 0x26,
	0x30, 0x48, 0x4D, 0x40, 0x20,
	0x38, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x38,
	0x2F, 0x10, 0xC8, 0xAC, 0xBA,
	0x2F, 0x10, 0x28, 0x34, 0xFA,
	0x00, 0x00, 0x7B, 0x00, 0x00,
	0x08, 0x14, 0x2A, 0x14, 0x22,
	0x22, 0x14, 0x2A, 0x14, 0x08,
	0x55, 0x00, 0x55, 0x00, 0x55, // #176 (25% block) missing in old code
	0xAA, 0x55, 0xAA, 0x55, 0xAA, // 50% block
	0xFF, 0x55, 0xFF, 0x55, 0xFF, // 75% block
	0x00, 0x00, 0x00, 0xFF, 0x00,
	0x10, 0x10, 0x10, 0xFF, 0x00,
	0x14, 0x14, 0x14, 0xFF, 0x00,
	0x10, 0x10, 0xFF, 0x00, 0xFF,
	0x10, 0x10, 0xF0, 0x10, 0xF0,
	0x14, 0x14, 0x14, 0xFC, 0x00,
	0x14, 0x14, 0xF7, 0x00, 0xFF,
	0x00, 0x00, 0xFF, 0x00, 0xFF,
	0x14, 0x14, 0xF4, 0x04, 0xFC,
	0x14, 0x14, 0x17, 0x10, 0x1F,
	0x10, 0x10, 0x1F, 0x10, 0x1F,
	0x14, 0x14, 0x14, 0x1F, 0x00,
	0x10, 0x10, 0x10, 0xF0, 0x00,
	0x00, 0x00, 0x00, 0x1F, 0x10,
	0x10, 0x10, 0x10, 0x1F, 0x10,
	0x10, 0x10, 0x10, 0xF0, 0x10,
	0x00, 0x00, 0x00, 0xFF, 0x10,
	0x10, 0x10, 0x10, 0x10, 0x10,
	0x10, 0x10, 0x10, 0xFF, 0x10,
	0x00, 0x00, 0x00, 0xFF, 0x14,
	0x00, 0x00, 0xFF, 0x00, 0xFF,
	0x00, 0x00, 0x1F, 0x10, 0x17,
	0x00, 0x00, 0xFC, 0x04, 0xF4,
	0x14, 0x14, 0x17, 0x10, 0x17,
	0x14, 0x14, 0xF4, 0x04, 0xF4,
	0x00, 0x00, 0xFF, 0x00, 0xF7,
	0x14, 0x14, 0x14, 0x14, 0x14,
	0x14, 0x14, 0xF7, 0x00, 0xF7,
	0x14, 0x14, 0x14, 0x17, 0x14,
	0x10, 0x10, 0x1F, 0x10, 0x1F,
	0x14, 0x14, 0x14, 0xF4, 0x14,
	0x10, 0x10, 0xF0, 0x10, 0xF0,
	0x00, 0x00, 0x1F, 0x10, 0x1F,
	0x00, 0x00, 0x00, 0x1F, 0x14,
	0x00, 0x00, 0x00, 0xFC, 0x14,
	0x00, 0x00, 0xF0, 0x10, 0xF0,
	0x10, 0x10, 0xFF, 0x10, 0xFF,
	0x14, 0x14, 0x14, 0xFF, 0x14,
	0x10, 0x10, 0x10, 0x1F, 0x00,
	0x00, 0x00, 0x00, 0xF0, 0x10,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
	0xFF, 0xFF, 0xFF, 0x00, 0x00,
	0x00, 0x00, 0x00, 0xFF, 0xFF,
	0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
	0x38, 0x44, 0x44, 0x38, 0x44,
	0xFC, 0x4A, 0x4A, 0x4A, 0x34, // sharp-s or beta
	0x7E, 0x02, 0x02, 0x06, 0x06,
	0x02, 0x7E, 0x02, 0x7E, 0x02,
	0x63, 0x55, 0x49, 0x41, 0x63,
	0x38, 0x44, 0x44, 0x3C, 0x04,
	0x40, 0x7E, 0x20, 0x1E, 0x20,
	0x06, 0x02, 0x7E, 0x02, 0x02,
	0x99, 0xA5, 0xE7, 0xA5, 0x99,
	0x1C, 0x2A, 0x49, 0x2A, 0x1C,
	0x4C, 0x72, 0x01, 0x72, 0x4C,
	0x30, 0x4A, 0x4D, 0x4D, 0x30,
	0x30, 0x48, 0x78, 0x48, 0x30,
	0xBC, 0x62, 0x5A, 0x46, 0x3D,
	0x3E, 0x49, 0x49, 0x49, 0x00,
	0x7E, 0x01, 0x01, 0x01, 0x7E,
	0x2A, 0x2A, 0x2A, 0x2A, 0x2A,
	0x44, 0x44, 0x5F, 0x44, 0x44,
	0x40, 0x51, 0x4A, 0x44, 0x40,
	0x40, 0x44, 0x4A, 0x51, 0x40,
	0x00, 0x00, 0xFF, 0x01, 0x03,
	0xE0, 0x80, 0xFF, 0x00, 0x00,
	0x08, 0x08, 0x6B, 0x6B, 0x08,
	0x36, 0x12, 0x36, 0x24, 0x36,
	0x06, 0x0F, 0x09, 0x0F, 0x06,
	0x00, 0x00, 0x18, 0x18, 0x00,
	0x00, 0x00, 0x10, 0x10, 0x00,
	0x30, 0x40, 0xFF, 0x01, 0x01,
	0x00, 0x1F, 0x01, 0x01, 0x1E,
	0x00, 0x19, 0x1D, 0x17, 0x12,
	0x00, 0x3C, 0x3C, 0x3C, 0x3C,
	0x00, 0x00, 0x00, 0x00, 0x00  // #255 NBSP
};

uint8_t _fgcolor = GLCD_TEXTFGCOLOR;
uint8_t _bgcolor = GLCD_TEXTBGCOLOR;
uint8_t _size = GLCD_TEXTSIZE;

#ifdef ST7586_H_
struct ST7586_reservedArea ST7586_DrawingArea;
struct ST7586_reservedArea PrintDrawingArea;
uint8_t ST7586_BufferEnabled = 0;
void glcd_useBuffer(struct ST7586_reservedArea *inst)
{
	ST7586_DrawingArea = *inst;
	ST7586_BufferEnabled = 1;
}

void glcd_useNormalMethod()
{
	ST7586_BufferEnabled = 0;
}

uint8_t glcd_getCurrentMethod()
{
	return ST7586_BufferEnabled;
}

void glcd_ST7586_setPixel(uint16_t x, uint16_t y, uint8_t c)
{
	if (ST7586_BufferEnabled)
	{
		if (ST7586_BufferEnabled == 2)
		{
			ST7586_setPixelReservedArea(&PrintDrawingArea, x, y, c);
		}
		else
		{
			ST7586_setPixelReservedArea(&ST7586_DrawingArea, x, y, c);
		}
	}
	else
	{
		ST7586_setPixel(x, y, c);
	}
}

void glcd_buf_print(uint16_t x, uint16_t y, char *character)
{
	PrintDrawingArea = ST7586_getReservedAreaMalloc(x,y,(strlen(character) * 6 * _size) + x, y + 8 * _size);
	uint8_t _temp = ST7586_BufferEnabled;
	ST7586_BufferEnabled = 2;
	
	while(*character)
	{
		glcd_char(x, y, *character, _fgcolor, _bgcolor, _size);
		if (*character++)
		{
			x += _size * 6;
		}
	}
	
	ST7586_sendReservedArea(&PrintDrawingArea);
	ST7586_destroyReservedArea(&PrintDrawingArea);
	ST7586_forcePixelUpdate();
	ST7586_BufferEnabled = _temp;
}

void glcd_buf_print_progmem(uint16_t x, uint16_t y,const char *character)
{
	PrintDrawingArea = ST7586_getReservedAreaMalloc(x, y, (strlen_P(character) * 6 * _size) + x, y + 8 * _size);
	uint8_t _temp = ST7586_BufferEnabled;
	ST7586_BufferEnabled = 2;
	
	char c = pgm_read_byte(character);
	while ( (c = pgm_read_byte(character++)) )
	{
		glcd_char(x, y, c, _fgcolor, _bgcolor, _size);
		x += _size * 6;
	}
	
	ST7586_sendReservedArea(&PrintDrawingArea);
	ST7586_destroyReservedArea(&PrintDrawingArea);
	ST7586_forcePixelUpdate();
	ST7586_BufferEnabled = _temp;
}
#endif

void glcd_load_image(const char image[], uint8_t colour)
{
	/*
	short pointer = 0;
	for(char w = 0; w < 8; w++){
		glcd_command(0xB8 | w, CS1);
		glcd_command(0xB8 | w, CS2);	
		glcd_command(0x40,CS1);
		glcd_command(0x40,CS2);
		for(char i = 0; i < 128; i++){
			if (i < 64){
				glcd_data_write(image[pointer], CS1);
			}
			else
			{	
				glcd_data_write(image[pointer], CS2);
			}
			pointer++;
		}
	}
	*/
	
	for (char cy = 0; cy < GLCD_HEIGHT; cy++)
	{
		for (char cx = 0; cx < GLCD_WIDTH; cx++)
		{
			if ( image[(cy * 16) + cx / 8] & (0x80>> (cx % 8)) )
			{
				GLCD_SETXY(cx, cy, colour);
			}
			else
			{
				GLCD_SETXY(cx, cy, (~colour) & 0x1);
			}
		}
	}
}
	
void glcd_draw_line(uint16_t x0, uint16_t y0, uint16_t x1, uint16_t y1, uint8_t colour)
{
	int dx =  abs(x1-x0), sx = x0<x1 ? 1 : -1;
	int dy = -abs(y1-y0), sy = y0<y1 ? 1 : -1;
	int err = dx+dy, e2; /* error value e_xy */
	
	while(1){
		GLCD_SETXY(x0,y0,colour);
		if (x0==x1 && y0==y1) break;
		e2 = 2*err;
		if (e2 > dy) { err += dy; x0 += sx; } /* e_xy+e_x > 0 */
		if (e2 < dx) { err += dx; y0 += sy; } /* e_xy+e_y < 0 */
	}
}

void glcd_draw_rectangle(uint16_t x0, uint16_t y0, uint16_t x1, uint16_t y1, uint8_t colour)
{
	glcd_draw_line(x0,y0,x0,y1,colour);
	glcd_draw_line(x0,y0,x1,y0,colour);
	glcd_draw_line(x0,y1,x1,y1,colour);
	glcd_draw_line(x1,y0,x1,y1,colour);	
}

void glcd_draw_rectangle_filled(uint16_t x0, uint16_t y0, uint16_t x1, uint16_t y1, uint8_t colour)
{
	for (uint16_t y = y0; y < y1; y++)
	{
		glcd_draw_line(x0,y,x1,y,colour);
	}
}

void glcd_drawBarV(uint16_t x0, uint16_t y0, uint16_t h, uint16_t w, uint16_t hFilled, uint8_t filledColor, uint8_t bgColor)
{
	glcd_draw_rectangle(x0,y0,x0+h,y0+w,filledColor);
}

void glcd_drawBarH(uint16_t x0, uint16_t y0, uint16_t h, uint16_t w, uint16_t wFilled, uint8_t filledColor, uint8_t bgColor)
{
	
}

void glcd_circle(uint16_t cx, uint16_t cy, uint16_t radius, uint8_t colour)
{
	int x, y, xchange, ychange, radiusError;
	x = radius;
	y = 0;
	xchange = 1 - 2 * radius;
	ychange = 1;
	radiusError = 0;
	while(x >= y)
	{
		GLCD_SETXY(cx+x, cy+y, colour); 
		GLCD_SETXY(cx-x, cy+y, colour); 
		GLCD_SETXY(cx-x, cy-y, colour);
		GLCD_SETXY(cx+x, cy-y, colour); 
		GLCD_SETXY(cx+y, cy+x, colour); 
		GLCD_SETXY(cx-y, cy+x, colour); 
		GLCD_SETXY(cx-y, cy-x, colour); 
		GLCD_SETXY(cx+y, cy-x, colour); 
		y++;
		radiusError += ychange;
		ychange += 2;
		if ( 2*radiusError + xchange > 0 )
		{
			x--;
			radiusError += xchange;
			xchange += 2;
		}
	}
}

void glcd_clear(uint8_t colour){
#ifdef KS0108_H
	for(char w = 0; w < 8; w++){
		
		for (char cs = 0; cs < KS0108_NUMOFCS; cs++)
		{
			ks0108_writeCommand(cs, 0xB8 | w);
			ks0108_writeCommand(cs, 0x40);
		}
		
		for(char i = 0; i < KS0108_WIDTH; i++){
			ks0108_writeData(i / 64, (colour) ? 0xFF : 0x00);
		}
	}
#else	
	for (char cy = 0; cy < GLCD_HEIGHT; cy++)
	{
		for (char cx = 0; cx < GLCD_WIDTH; cx++)
		{
			GLCD_SETXY(cx, cy, colour);
		}
	}
#endif
}

void glcd_invert(){
#ifdef KS0108_H
	for(char w = 0; w < 8; w++){
		
		for (char cs = 0; cs < KS0108_NUMOFCS; cs++)
		{
			ks0108_writeCommand(cs, 0xB8 | w);
			ks0108_writeCommand(cs, 0x40);
		}
		
		for(char x = 0; x < KS0108_WIDTH; x++)
		{				
			char controller = x >> 6;
			char data;
			char tempx = x;
			if(controller){
				tempx -= 64;
			}
			ks0108_writeCommand(controller, 0x40 | x);
			data = ks0108_readData(controller);
			data = ks0108_readData(controller);
			ks0108_writeCommand(controller,0x40 | x);
			ks0108_writeData(controller, ~data);
				
				
			//ks0108_writeData(i / 64, (colour) ? 0xFF : 0x00);
		}
	}
#else
	for (char cy = 0; cy < GLCD_HEIGHT; cy++)
	{
		for (char cx = 0; cx < GLCD_WIDTH; cx++)
		{
			GLCD_INVXY(cx,cy);
		}
	}
#endif
}


void glcd_setTextBGcolor(uint8_t bgcolor)
{
	_bgcolor = bgcolor;
}

void glcd_setTextFGcolor(uint8_t fgcolor)
{
	_fgcolor = fgcolor;
}

void glcd_setTextSize(uint8_t size)
{
	_size = size;
}

void glcd_char(uint16_t x, uint16_t y, char character, uint8_t fgcolor, uint8_t bgcolor, uint8_t size)
{

	if((x >= GLCD_WIDTH)            || // Clip right
		(y >= GLCD_HEIGHT)           || // Clip bottom
		((x + 6 * size - 1) < 0) || // Clip left
		((y + 8 * size - 1) < 0))   // Clip top
	return;

	for(char i=0; i<5; i++ )
	{ // Char bitmap = 5 columns
		char line = pgm_read_byte(&(font[character * 5 + i]));
		for(char j=0; j<8; j++, line >>= 1) 
		{
			if(line & 1)
			{
				if (size == 1)
				{
					GLCD_SETXY(x+i, y+j, fgcolor);
				}
				else
				{
					glcd_draw_rectangle_filled(x+i*size, y+j*size, (x+i*size) + size, (y+j*size) + size, fgcolor);
				}
			}
			else
			{
				if (size == 1)
				{
					GLCD_SETXY(x+i,y+j, bgcolor);
				}
				else
				{
					glcd_draw_rectangle_filled(x+i*size, y+j*size, (x+i*size) + size, (y+j*size) + size, bgcolor);
				}
			}
		}
	}
}

void glcd_print(uint16_t x, uint16_t y,char *character)
{	
#ifdef ST7586_H_
	ST7586_DrawingArea = ST7586_getReservedAreaMalloc(x,y,(strlen(character)*6)+x,y+8);
#endif
	while(*character)
	{
		glcd_char(x, y, *character++, _fgcolor, _bgcolor, _size);
		if (*character++)
			x += _size * 6;
	}
#ifdef ST7586_H_
	ST7586_sendReservedArea(&ST7586_DrawingArea);
	ST7586_destroyReservedArea(&ST7586_DrawingArea);
#endif // ST7586_H_
}



void glcd_print_progmem(uint16_t x, uint16_t y,const char *character)
{
#ifdef ST7586_H_
	ST7586_DrawingArea = ST7586_getReservedAreaMalloc(x, y, (strlen_P(character) * 6) + x, y + 8);
#endif
	char c;
	while ( (c = pgm_read_byte(character++)) )
	{
		glcd_char(x, y, c, _fgcolor, _bgcolor, _size);
		x += _size * 6;
	}
#ifdef ST7586_H_
	ST7586_sendReservedArea(&ST7586_DrawingArea);
	ST7586_destroyReservedArea(&ST7586_DrawingArea);
#endif
}